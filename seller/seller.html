<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>İmame – Satıcı Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f9f5f0; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --bordo:#7b2c2c; --bordo-700:#682323; --altin:#d4af37;
      --ok-bg:#ecfdf5; --ok-b:#a7f3d0; --ok-t:#065f46;
      --err-bg:#fef2f2; --err-b:#fecaca; --err-t:#991b1b;
      --chip:#eef2ff; --chip-t:#3730a3;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);margin:0;padding:24px;color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:var(--card);border-radius:18px;box-shadow:0 14px 40px rgba(0,0,0,.08);padding:24px}
    h1{margin:0 0 12px;font-weight:800;letter-spacing:.2px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand:before{content:"";width:10px;height:28px;border-radius:999px;background:linear-gradient(180deg,var(--altin),#f5e6a0)}
    .banner{background:#eef7ea;border:1px solid #cde7bf;color:#234b1f;padding:12px 16px;border-radius:12px;margin-bottom:16px}

    nav{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 16px}
    .tab{border:0;padding:10px 14px;border-radius:12px;background:var(--chip);color:var(--chip-t);cursor:pointer;font-weight:800}
    .tab.active{background:var(--bordo);color:#fff}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{font-weight:600;font-size:14px;margin-bottom:6px;display:block}
    input,textarea,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fcfcfd;font-size:14px}
    textarea{min-height:110px}
    .btn{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:800}
    .btn-primary{background:var(--bordo);color:#fff}
    .btn-primary:hover{background:var(--bordo-700)}
    .btn-ghost{background:#f0e7da;color:var(--bordo)}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(.2)}

    .hint{font-size:12px;color:var(--muted)}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .list{display:grid;gap:12px;margin-top:12px}
    .item{display:flex;gap:14px;align-items:center;background:#fafafa;border:1px solid #eee;border-radius:14px;padding:12px}
    .thumb{width:64px;height:64px;border-radius:10px;object-fit:cover;border:1px solid #eee}
    .right{margin-left:auto;display:flex;gap:10px}

    .ok{background:var(--ok-bg);color:var(--ok-t);border:1px solid var(--ok-b);padding:12px;border-radius:12px}
    .err{background:var(--err-bg);color:var(--err-t);border:1px solid var(--err-b);padding:12px;border-radius:12px}
    .preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;cursor:pointer}

    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge--pending{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
    .badge--approved{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .badge--rejected{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}

    .addr{margin-top:8px;padding:10px;border-radius:12px;background:#fff;border:1px solid #eee;color:#374151;font-size:14px;line-height:1.45}
    .addr b{color:#111827}
    .copy-btn{margin-top:8px}

    /* OVERVIEW */
    .overview{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin:6px 0 18px}
    .kpi{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px}
    .kpi .t{font-size:12px;color:#6b7280}
    .kpi .v{font-size:22px;font-weight:800;margin-top:4px}
    .kpi .s{font-size:12px;color:#6b7280;margin-top:2px}
    @media (max-width:1100px){ .overview{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:700px){ .overview{grid-template-columns:repeat(2,1fr);} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="brand">İmame – Satıcı Paneli</h1>

      <!-- Login -->
      <div id="loginView">
        <div class="row" style="margin-top:10px">
          <div>
            <label>E-posta</label>
            <input id="email" placeholder="ornek@imame.com" />
          </div>
          <div>
            <label>Şifre</label>
            <input id="password" type="password" placeholder="••••••••" />
          </div>
        </div>
        <div class="stack" style="margin-top:12px">
          <button class="btn btn-primary" id="loginBtn">Giriş Yap</button>
        </div>
        <div id="msg" style="margin-top:12px"></div>
      </div>

      <!-- App -->
      <div id="appView" style="display:none">
        <div id="profileBox" class="banner"></div>

        <!-- OVERVIEW -->
        <div class="overview">
          <div class="kpi">
            <div class="t">Bugün Satış</div>
            <div class="v" id="kpiToday">₺0</div>
            <div class="s">onaylanan mezatlar</div>
          </div>
          <div class="kpi">
            <div class="t">Bu Hafta Satış</div>
            <div class="v" id="kpiWeek">₺0</div>
            <div class="s">Pzt 00:00 – şimdi</div>
          </div>
          <div class="kpi">
            <div class="t">Geçen Hafta Satış</div>
            <div class="v" id="kpiPrevWeek">₺0</div>
            <div class="s">Geçen Pzt 00:00 – Bu Pzt 00:00</div>
          </div>
          <div class="kpi" id="kpiPendingWrap">
            <div class="t">Bekleyen Dekont</div>
            <div class="v" id="kpiPending">0</div>
            <div class="s">onay/reddet bekliyor</div>
          </div>
          <div class="kpi">
            <div class="t">Bugün 22:00’a Kalan</div>
            <div class="v" id="kpi2200">--:--:--</div>
            <div class="s">Europe/Istanbul</div>
          </div>
        </div>

        <nav>
          <button class="tab active" data-tab="add">Mezat Ekle</button>
          <button class="tab" data-tab="mine">Mezatlarım</button>
          <button class="tab" data-tab="receipts">Dekont Onayla</button>
        </nav>

        <!-- Mezat Ekle -->
        <section id="tab-add">
          <div class="row">
            <div>
              <label>Başlık</label>
              <input id="title" placeholder="Örn: Usta imzalı ..." />
            </div>
            <div>
              <label>Başlangıç Fiyatı (₺)</label>
              <input id="startingPrice" type="number" min="0" step="1" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Usta İmzalı</label>
              <select id="isSigned">
                <option value="false">Hayır</option>
                <option value="true">Evet</option>
              </select>
            </div>
            <div>
              <label>Bitiş Saati</label>
              <input disabled value="Her gün 22:00 (otomatik)" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Açıklama</label>
            <textarea id="description" placeholder="- Taş: …&#10;- Ölçüler: …&#10;- Usta: …"></textarea>
          </div>

          <div style="margin-top:10px">
            <label>Görseller (max 5)</label>
            <input id="images" type="file" accept="image/*" multiple />
            <div id="prev" class="preview"></div>
            <div class="hint">Önizlemelere tıklayarak büyük gör.</div>
          </div>

          <div class="stack" style="margin-top:12px">
            <button class="btn btn-ghost" id="createBtn">Mezatı Kaydet (bitiş: bugün/yarın 22:00)</button>
          </div>
          <div id="out-add" style="margin-top:12px"></div>
        </section>

        <!-- Mezatlarım -->
        <section id="tab-mine" style="display:none">
          <div class="list" id="mineList"></div>
        </section>

        <!-- Dekont Onayla -->
        <section id="tab-receipts" style="display:none">
          <div id="out-receipts" style="margin-bottom:10px"></div>
          <div class="list" id="receiptList"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Görsel Modal -->
  <div class="modal" id="imgModal" aria-hidden="true">
    <button class="modal-close" id="modalClose">×</button>
    <div class="modal-card"><img id="modalImg" alt="Dekont" /></div>
  </div>

<script>
  /* ==================== API & PATHS ==================== */
  const api = {
    login: '/api/auth/login',
    profile: '/api/seller/profile',
    createAuction: '/api/seller/auctions',
    myAuctions: '/api/seller/auctions',
    receiptsMine: (sellerId) => `/api/receipts/mine/${sellerId}`,
    approve: (auctionId) => `/api/receipts/${auctionId}/approve`,
    reject:  (auctionId) => `/api/receipts/${auctionId}/reject`,
  };

  const ADDR_JSON = {
    sehir:      'seller-assets/sehirler.json',
    ilce:       'seller-assets/ilceler.json',
    mahalle_1:  'seller-assets/mahalleler-1.json',
    mahalle_2:  'seller-assets/mahalleler-2.json',
    mahalle_3:  'seller-assets/mahalleler-3.json',
    mahalle_4:  'seller-assets/mahalleler-4.json',
  };

  /* ==================== STATE & HELPERS ==================== */
  const $ = id => document.getElementById(id);
  const msg = (el, text, ok=true) => el.innerHTML = `<div class="${ok?'ok':'err'}">${text}</div>`;
  let token = localStorage.getItem('seller_token') || '';
  let sellerId = localStorage.getItem('seller_id') || '';
  let userCache = null;

  const maps = { sehir: new Map(), ilce: new Map(), mahalle: new Map() };

  const fmtTL = n => '₺' + (Number(n||0)).toLocaleString('tr-TR', {maximumFractionDigits:0});
  const toTR = d => new Intl.DateTimeFormat('tr-TR', {
    timeZone:'Europe/Istanbul', year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).format(d);

  function msToHMS(ms){
    if (ms<=0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600).toString().padStart(2,'0');
    const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
    const ss= (s%60).toString().padStart(2,'0');
    return `${h}:${m}:${ss}`;
  }

  // Login/App görünümü
  function showLogin(reason){
    $('loginView').style.display='block';
    $('appView').style.display='none';
    if (reason) msg($('msg'), reason, false);
  }
  function showApp(){
    $('loginView').style.display='none';
    $('appView').style.display='block';
  }
  function logout(reason){
    token=''; sellerId=''; userCache=null;
    localStorage.removeItem('seller_token');
    localStorage.removeItem('seller_id');
    localStorage.removeItem('user');
    showLogin(reason || 'Oturum süreniz doldu. Lütfen tekrar giriş yapın.');
  }
  async function apiFetch(url, opts={}){
    const headers = { ...(opts.headers||{}) };
    if (token) headers.Authorization = 'Bearer ' + token;
    const res = await fetch(url, { ...opts, headers });
    if (res.status === 401 || res.status === 403){
      logout('Oturum süreniz doldu. Lütfen tekrar giriş yapın.');
      throw new Error('unauthorized');
    }
    return res;
  }

  // Bugün 22:00 (Europe/Istanbul) hedef epoch (ms)
  function nextIstanbul2200UtcMs() {
    const parts = new Intl.DateTimeFormat('tr-TR', {
      timeZone: 'Europe/Istanbul',
      hourCycle: 'h23',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    }).formatToParts(new Date());

    let h=0,m=0,s=0;
    for (const p of parts) {
      if (p.type === 'hour')   h = parseInt(p.value,10);
      if (p.type === 'minute') m = parseInt(p.value,10);
      if (p.type === 'second') s = parseInt(p.value,10);
    }
    const nowSec = h*3600 + m*60 + s;
    let leftSec = 22*3600 - nowSec;
    if (leftSec <= 0) leftSec += 24*3600;
    return Date.now() + leftSec*1000;
  }

  const timers = [];
  function registerCountdown(el, targetMs){ timers.push({el, target:targetMs}); }
  function tickTimers(){
    const now = Date.now();
    for (const t of timers){ t.el.textContent = msToHMS(t.target - now); }
  }
  setInterval(tickTimers, 1000);

  // JSON → Map indeksleme
  function pick(obj, keys){
    for (const k of keys){
      if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== '') return obj[k];
    }
    return undefined;
  }
  function collectIdNamePairs(json, idKeys, nameKeys, out){
    if (Array.isArray(json)){ for (const it of json) collectIdNamePairs(it, idKeys, nameKeys, out); return; }
    if (json && typeof json === 'object'){
      const idRaw = pick(json, idKeys);
      const nameRaw = pick(json, nameKeys);
      if (idRaw !== undefined && nameRaw){
        const id = Number(idRaw), name = String(nameRaw);
        if (!Number.isNaN(id)) out.push([id, name]);
      }
      for (const v of Object.values(json)) collectIdNamePairs(v, idKeys, nameKeys, out);
    }
  }
  function addFromJsonToMap(json, map, idKeys, nameKeys){
    const pairs = []; collectIdNamePairs(json, idKeys, nameKeys, pairs);
    for (const [id, name] of pairs) if (!map.has(id)) map.set(id, name);
  }

  async function loadAddressMaps(){
    try{
      const s = await (await fetch(ADDR_JSON.sehir)).json();
      addFromJsonToMap(s, maps.sehir,
        ['id','SehirID','sehir_id','ilId','il_id','SehirNo'],
        ['name','SehirAdi','sehir_adi','title','ilAdi','il_adi']);
    }catch(e){ console.warn('Şehirler yüklenemedi:', e); }

    try{
      const ic = await (await fetch(ADDR_JSON.ilce)).json();
      addFromJsonToMap(ic, maps.ilce,
        ['id','IlceID','ilce_id','ilceId'],
        ['name','IlceAdi','ilce_adi','ilce_title','title']);
    }catch(e){ console.warn('İlçeler yüklenemedi:', e); }

    for (const url of [ADDR_JSON.mahalle_1, ADDR_JSON.mahalle_2, ADDR_JSON.mahalle_3, ADDR_JSON.mahalle_4]){
      try{
        const m = await (await fetch(url)).json();
        addFromJsonToMap(m, maps.mahalle,
          ['id','MahalleID','mahalle_id','mahalleId'],
          ['name','MahalleAdi','mahalle_adi','mahalle_title','title']);
      }catch(e){ console.warn('Mahalle dosyası yüklenemedi:', url, e); }
    }
  }
  const nameOf = (map, id) => (id==null ? '' : (map.get(Number(id)) || String(id)));

  function setTab(name){
    document.querySelectorAll('nav .tab').forEach(b => b.classList.toggle('active', b.dataset.tab===name));
    ['add','mine','receipts'].forEach(t => $('tab-'+t).style.display = (t===name?'block':'none'));
  }
  document.querySelectorAll('nav .tab').forEach(b => b.addEventListener('click', () => setTab(b.dataset.tab)));

  const prev = $('prev'); const imgModal = $('imgModal'); const modalImg = $('modalImg'); const modalClose = $('modalClose');
  $('images')?.addEventListener('change', (e) => {
    if(!prev) return;
    prev.innerHTML = '';
    [...e.target.files].slice(0,5).forEach(f => {
      const u = URL.createObjectURL(f);
      const i = new Image(); i.src=u; i.width=96; i.height=96; i.className='preview-img';
      i.onclick = () => openModal(u);
      prev.appendChild(i);
    });
  });
  function openModal(src){ modalImg.src = src; imgModal.classList.add('open'); imgModal.setAttribute('aria-hidden','false'); }
  function closeModal(){ imgModal.classList.remove('open'); imgModal.setAttribute('aria-hidden','true'); }
  modalClose.onclick = closeModal;
  imgModal.addEventListener('click', (e) => { if(e.target===imgModal) closeModal(); });

  /* ==================== LOGIN ==================== */
  $('loginBtn').addEventListener('click', async () => {
    try {
      const r = await fetch(api.login, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email: $('email').value.trim(), password: $('password').value })
      });
      const j = await r.json();
      const tok = j.token || j.accessToken || j.jwt;
      if (!r.ok || !tok) return msg($('msg'), j.message||'Giriş başarısız', false);
      if ((j.user && j.user.role) !== 'seller') return msg($('msg'),'Bu panele sadece satıcı girebilir.', false);

      token = tok; sellerId = j.user._id; userCache = j.user;
      localStorage.setItem('seller_token', token);
      localStorage.setItem('seller_id', sellerId);
      localStorage.setItem('user', JSON.stringify(j.user));

      showApp();
      await loadProfile();
      await loadAddressMaps();
      await loadMine();      // KPI’lar (bugün/hafta/geçen hafta)
      await loadReceipts();  // Bekleyen dekont KPI
    } catch {
      msg($('msg'),'Ağ hatası', false);
    }
  });

  // Profil
  async function loadProfile(){
    try{
      const r = await apiFetch(api.profile);
      const j = await r.json();
      const u = j?.user || userCache || JSON.parse(localStorage.getItem('user')||'{}');
      $('profileBox').innerHTML = `
        <b>Hoş geldiniz:</b> ${u.companyName||u.name||u.email}
        &nbsp; • &nbsp; <b>E-posta:</b> ${u.email}
        <span style="float:right">
          <button class="btn btn-ghost" id="logoutBtn">Çıkış</button>
        </span>`;
      $('logoutBtn')?.addEventListener('click', () => logout('Oturumdan çıkış yaptınız.'));
    }catch{}
  }

  // OVERVIEW: 22:00 countdown
  (function boot2200(){
    const el = $('kpi2200');
    if (!el) return;
    let target = nextIstanbul2200UtcMs();
    registerCountdown(el, target);
    setInterval(() => { if ((target - Date.now()) <= 0) target = nextIstanbul2200UtcMs(); }, 1000);
  })();

  // Mezat Ekle
  $('createBtn').addEventListener('click', async () => {
    const out = $('out-add');
    try {
      const fd = new FormData();
      fd.append('title', $('title').value);
      fd.append('description', $('description').value);
      fd.append('startingPrice', $('startingPrice').value);
      fd.append('isSigned', $('isSigned').value);
      [...$('images').files].slice(0,5).forEach(f => fd.append('images', f));

      const r = await apiFetch(api.createAuction, { method:'POST', body: fd });
      const j = await r.json();
      if (!j.ok) return msg(out, j.message||'Kayıt hatası', false);

      msg(out, 'Mezat oluşturuldu. ID: '+j.auctionId);
      ['title','description','startingPrice'].forEach(id => $(id).value='');
      if ($('images')) $('images').value=''; if (prev) prev.innerHTML='';
      await loadMine();
    } catch (e) { if (e.message!=='unauthorized') msg(out,'Ağ hatası', false); }
  });

  // Mezatlarım (kartlarda geri sayım KALDIRILDI)
  async function loadMine(){
    const box = $('mineList'); if (!box) return; box.innerHTML = '';
    try{
      const r = await apiFetch(api.myAuctions);
      const j = await r.json();
      if (!j.ok) { box.innerHTML = '<div class="err">Liste alınamadı</div>'; return; }

      calcKpisFromAuctions(j.items||[]);

      (j.items||[]).forEach(a => {
        const d = document.createElement('div'); d.className='item';
        const img = document.createElement('img'); img.src = (a.images && a.images[0]) || ''; img.className='thumb';
        const info = document.createElement('div');
        const status = a.isEnded ? `Bitti (${a.receiptStatus||'-'})` : 'Devam ediyor';
        const endText = a.endsAt ? toTR(new Date(a.endsAt)) : '-';
        info.innerHTML = `<b>${a.title}</b><br/>₺${(a.currentPrice||0)} • Bitiş: ${endText} • ${status}`;
        d.appendChild(img); d.appendChild(info);
        box.appendChild(d);
      });
    }catch(e){ if (e.message!=='unauthorized') box.innerHTML = '<div class="err">Liste alınamadı</div>'; }
  }

  // KPI’lar: bugün/hafta/geçen hafta (sadece APPROVED)
  function calcKpisFromAuctions(items){
    const tz = 'Europe/Istanbul';
    const now = new Date();

    // Istanbul “bugün 00:00”
    const todayParts = new Intl.DateTimeFormat('tr-TR', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' })
      .formatToParts(now);
    const y = Number(todayParts.find(p=>p.type==='year').value);
    const m = Number(todayParts.find(p=>p.type==='month').value)-1;
    const d = Number(todayParts.find(p=>p.type==='day').value);
    const startTodayIst = new Date(Date.UTC(y, m, d, 0, 0, 0)); // UTC karşılığı

    // Hafta başlangıcı (Pazartesi 00:00, Istanbul)
    const anchor = new Date(Date.UTC(y, m, d, 12, 0, 0)); // gün kaymasını önlemek için 12:00
    const wd = new Intl.DateTimeFormat('en-GB', { weekday:'short', timeZone: tz }).format(anchor);
    const map = {Mon:0,Tue:-1,Wed:-2,Thu:-3,Fri:-4,Sat:-5,Sun:-6};
    const shift = map[wd] ?? 0;
    const startWeekIst = new Date(Date.UTC(y, m, d+shift, 0,0,0));
    const startPrevWeekIst = new Date(startWeekIst.getTime() - 7*24*3600*1000);

    let today=0, week=0, prevWeek=0;

    for (const a of (items||[])){
      if (!a.isEnded) continue;
      const approved = (a.receiptStatus||'').toLowerCase()==='approved';
      if (!approved) continue;

      const price = Number(a.currentPrice||0);
      const endMs = a.endsAt ? new Date(a.endsAt).getTime() : 0;

      if (endMs >= startTodayIst.getTime()) today += price;
      if (endMs >= startWeekIst.getTime())  week  += price;
      if (endMs >= startPrevWeekIst.getTime() && endMs < startWeekIst.getTime()) prevWeek += price;
    }

    $('kpiToday').textContent = fmtTL(today);
    $('kpiWeek').textContent  = fmtTL(week);
    $('kpiPrevWeek').textContent = fmtTL(prevWeek);
  }

  // Dekontlar – bekleyen say, 0 ise KPI’ı gizle
  async function loadReceipts(){
    const out = $('out-receipts'); const box = $('receiptList'); if (!box) return; box.innerHTML='';
    const sid = sellerId || (JSON.parse(localStorage.getItem('user')||'{}')._id);
    if (!sid){ msg(out,'Satıcı ID bulunamadı', false); return; }

    try{
      const r = await apiFetch(api.receiptsMine(sid));
      const items = await r.json();

      // KPI: sadece pending
      const pendingCount = (items||[]).filter(x => (x.receiptStatus||'').toLowerCase()==='pending').length;
      $('kpiPending').textContent = String(pendingCount);
      $('kpiPendingWrap').style.display = pendingCount > 0 ? '' : 'none';

      if (!Array.isArray(items) || items.length===0){
        msg(out,'Gösterilecek dekont bulunamadı', false); return;
      }
      out.innerHTML = '';

      items.forEach(x => {
        const li = document.createElement('div'); li.className='item';

        const img = document.createElement('img'); img.src = x.receiptUrl || ''; img.className='thumb';
        img.style.cursor='zoom-in'; img.onclick = () => openModal(x.receiptUrl || '');

        const info = document.createElement('div');
        const buyer = x.buyer || {};
        const buyerName = buyer.name || buyer.email || '-';
        const status = (x.receiptStatus || 'pending').toLowerCase();
        const badgeClass = status==='approved' ? 'badge--approved' : status==='rejected' ? 'badge--rejected' : 'badge--pending';

        let addrHtml = '';
        if (status === 'approved' && buyer.address){
          const a = buyer.address;
          const ilName = nameOf(maps.sehir, a.ilId);
          const ilceName = nameOf(maps.ilce, a.ilceId);
          const mahalleName = nameOf(maps.mahalle, a.mahalleId);

          const mah = (mahalleName||'').toLocaleLowerCase('tr-TR').trim();
          const sok = (a.sokak||'').trim();
          const no  = a.apartmanNo ? ` no:${a.apartmanNo}` : '';
          const dr  = a.daireNo ? ` Daire:${a.daireNo}` : '';
          const son = `${ilceName||''}/${ilName||''}`;
          const line = `${mah} mahallesi ${sok}${no}${dr} ${son}`.replace(/\s+/g,' ').trim();

          addrHtml = `
            <div class="addr">
              <b>Alıcı Adresi</b><br/>
              ${line}
              <div><button class="btn btn-ghost copy-btn" onclick="navigator.clipboard.writeText('${line.replace(/'/g,"\\'")}')">Kopyala</button></div>
            </div>`;
        }

        info.innerHTML = `
          <b>${x.title}</b><br/>
          Kazanan: ${buyerName}<br/>
          Bitiş: ${x.endsAt ? toTR(new Date(x.endsAt)) : '-'}<br/>
          Durum: <span class="badge ${badgeClass}">${status}</span>
          ${addrHtml}
        `;

        const actions = document.createElement('div'); actions.className='right';
        const isPending = status === 'pending';
        const ok = document.createElement('button'); ok.className='btn btn-primary'; ok.textContent='Onayla';
        const no = document.createElement('button'); no.className='btn btn-ghost';  no.textContent='Reddet';
        ok.disabled = !isPending; no.disabled = !isPending;

        ok.onclick = async () => {
          if (!isPending) return;
          const rr = await apiFetch(api.approve(x._id), { method:'PATCH' });
          if (rr.ok) loadReceipts(); else alert('Onay başarısız');
        };
        no.onclick = async () => {
          if (!isPending) return;
          const rr = await apiFetch(api.reject(x._id),  { method:'PATCH' });
          if (rr.ok) loadReceipts(); else alert('Reddetme başarısız');
        };

        li.appendChild(img); li.appendChild(info); li.appendChild(actions);
        actions.appendChild(ok); actions.appendChild(no);
        box.appendChild(li);
      });
    }catch(e){
      if (e.message!=='unauthorized') msg(out,'Dekont listesi alınamadı', false);
    }
  }

  document.querySelector('[data-tab="mine"]').addEventListener('click', loadMine);
  document.querySelector('[data-tab="receipts"]').addEventListener('click', loadReceipts);

  // Boot
  (async function boot(){
    const has = token && sellerId;
    if (has){
      showApp();
      try{ userCache = JSON.parse(localStorage.getItem('user')||'{}'); }catch{}
      try{
        await loadProfile();  // 401 ise apiFetch logout çağırır
      }catch{ return; }
      await loadAddressMaps();
      await loadMine();
      await loadReceipts();
    }
  })();
</script>
</body>
</html>
