<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>İmame – Satıcı Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f9f5f0; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --bordo:#7b2c2c; --bordo-700:#682323; --altin:#d4af37;
      --ok-bg:#ecfdf5; --ok-b:#a7f3d0; --ok-t:#065f46;
      --err-bg:#fef2f2; --err-b:#fecaca; --err-t:#991b1b;
      --chip:#eef2ff; --chip-t:#3730a3;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);margin:0;padding:24px;color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:var(--card);border-radius:18px;box-shadow:0 14px 40px rgba(0,0,0,.08);padding:24px}
    h1{margin:0 0 12px;font-weight:800;letter-spacing:.2px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand:before{content:"";width:10px;height:28px;border-radius:999px;background:linear-gradient(180deg,var(--altin),#f5e6a0)}

    .banner{
      background:#eef7ea;border:1px solid #cde7bf;color:#234b1f;
      padding:12px 16px;border-radius:12px;margin-bottom:16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }

    /* OVERVIEW KPIs */
    .overview{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin:6px 0 18px}
    .kpi{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px}
    .kpi-title{font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px}
    .kpi-value{font-size:20px;font-weight:900}
    @media (max-width:900px){.overview{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.overview{grid-template-columns:1fr}}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{font-weight:600;font-size:14px;margin-bottom:6px;display:block}
    input,textarea,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fcfcfd;font-size:14px}
    textarea{min-height:110px}
    nav{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 16px}

    .tab{border:0;padding:10px 14px;border-radius:12px;background:var(--chip);color:var(--chip-t);cursor:pointer;font-weight:800}
    .tab.active{background:var(--bordo);color:#fff}
    .btn{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:800}
    .btn-primary{background:var(--bordo);color:#fff}
    .btn-primary:hover{background:var(--bordo-700)}
    .btn-ghost{background:#f0e7da;color:var(--bordo)}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(0.2);}

    .hint{font-size:12px;color:var(--muted)}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .list{display:grid;gap:12px;margin-top:12px}
    .item{display:flex;gap:14px;align-items:center;background:#fafafa;border:1px solid #eee;border-radius:14px;padding:12px}
    .thumb{width:64px;height:64px;border-radius:10px;object-fit:cover;border:1px solid #eee}
    .right{margin-left:auto;display:flex;gap:10px}
    .ok{background:var(--ok-bg);color:var(--ok-t);border:1px solid var(--ok-b);padding:12px;border-radius:12px}
    .err{background:var(--err-bg);color:var(--err-t);border:1px solid var(--err-b);padding:12px;border-radius:12px}
    .preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;cursor:pointer}

    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge--pending{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
    .badge--approved{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .badge--rejected{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}

    .addr{margin-top:8px;padding:10px;border-radius:12px;background:#fff;border:1px solid #eee;color:#374151;font-size:14px;line-height:1.45}
    .addr b{color:#111827}

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.open{display:flex}
    .modal-card{background:#0b0b0b;border-radius:14px;padding:8px;max-width:95vw;max-height:90vh}
    .modal img{max-width:90vw;max-height:85vh;border-radius:10px;display:block}
    .modal-close{position:absolute;top:20px;right:20px;background:#fff;border:0;border-radius:999px;width:38px;height:38px;font-weight:900;cursor:pointer}

    .timer{font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="brand">İmame – Satıcı Paneli</h1>

      <!-- Login -->
      <div id="loginView">
        <div class="row" style="margin-top:10px">
          <div>
            <label>E-posta</label>
            <input id="email" placeholder="ornek@imame.com" />
          </div>
          <div>
            <label>Şifre</label>
            <input id="password" type="password" placeholder="••••••••" />
          </div>
        </div>
        <div class="stack" style="margin-top:12px">
          <button class="btn btn-primary" id="loginBtn">Giriş Yap</button>
        </div>
        <div id="msg" style="margin-top:12px"></div>
      </div>

      <!-- App -->
      <div id="appView" style="display:none">
        <div class="banner">
          <div id="profileBox"></div>
          <button class="btn btn-ghost" id="logoutBtn">Çıkış</button>
        </div>

        <!-- OVERVIEW -->
        <div class="overview">
          <div class="kpi"><div class="kpi-title">Bugünkü Satış</div><div class="kpi-value" id="kpi-today">₺0</div></div>
          <div class="kpi"><div class="kpi-title">Bu Hafta Satış</div><div class="kpi-value" id="kpi-week">₺0</div></div>
          <div class="kpi"><div class="kpi-title">Bekleyen Dekont</div><div class="kpi-value" id="kpi-pending">0</div></div>
          <div class="kpi"><div class="kpi-title">Kargoya Hazır</div><div class="kpi-value" id="kpi-approved">0</div></div>
          <div class="kpi"><div class="kpi-title">Yakında Bitecek (&le;2s)</div><div class="kpi-value" id="kpi-ending">0</div></div>
        </div>

        <nav>
          <button class="tab active" data-tab="add">Mezat Ekle</button>
          <button class="tab" data-tab="mine">Mezatlarım</button>
          <button class="tab" data-tab="receipts">Dekont Onayla</button>
        </nav>

        <!-- Mezat Ekle -->
        <section id="tab-add">
          <div class="row">
            <div>
              <label>Başlık</label>
              <input id="title" placeholder="Örn: Usta imzalı ..." />
            </div>
            <div>
              <label>Başlangıç Fiyatı (₺)</label>
              <input id="startingPrice" type="number" min="0" step="1" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Usta İmzalı</label>
              <select id="isSigned">
                <option value="false">Hayır</option>
                <option value="true">Evet</option>
              </select>
            </div>
            <div>
              <label>Bitiş Saati</label>
              <input disabled value="Her gün 22:00 (otomatik)" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Açıklama</label>
            <textarea id="description" placeholder="- Taş: …&#10;- Ölçüler: …&#10;- Usta: …"></textarea>
          </div>

          <div style="margin-top:10px">
            <label>Görseller (max 5)</label>
            <input id="images" type="file" accept="image/*" multiple />
            <div id="prev" class="preview"></div>
            <div class="hint">Önizlemelere tıklayarak büyük gör.</div>
          </div>

          <div class="stack" style="margin-top:12px">
            <button class="btn btn-ghost" id="createBtn">Mezatı Kaydet (bitiş: bugün/yarın 22:00)</button>
          </div>
          <div id="out-add" style="margin-top:12px"></div>
        </section>

        <!-- Mezatlarım -->
        <section id="tab-mine" style="display:none">
          <div class="list" id="mineList"></div>
        </section>

        <!-- Dekont Onayla -->
        <section id="tab-receipts" style="display:none">
          <div id="out-receipts" style="margin-bottom:10px"></div>
          <div class="list" id="receiptList"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Görsel Modal -->
  <div class="modal" id="imgModal" aria-hidden="true">
    <button class="modal-close" id="modalClose">×</button>
    <div class="modal-card"><img id="modalImg" alt="Dekont" /></div>
  </div>

<script>
  // ---- API endpoints
  const api = {
    login: '/api/auth/login',
    profile: '/api/seller/profile',
    createAuction: '/api/seller/auctions',
    myAuctions: '/api/seller/auctions',
    receiptsMine: (sellerId) => `/api/receipts/mine/${sellerId}`,
    approve: (auctionId) => `/api/receipts/${auctionId}/approve`,
    reject:  (auctionId) => `/api/receipts/${auctionId}/reject`,
  };

  // ---- Address JSON paths (seller/ altında seller-assets klasörü)
  const ADDR_JSON = {
    sehir:      'seller-assets/sehirler.json',
    ilce:       'seller-assets/ilceler.json',
    mahalle_1:  'seller-assets/mahalleler-1.json',
    mahalle_2:  'seller-assets/mahalleler-2.json',
    mahalle_3:  'seller-assets/mahalleler-3.json',
    mahalle_4:  'seller-assets/mahalleler-4.json',
  };

  // ---- State & helpers
  const $ = id => document.getElementById(id);
  const msg = (el, text, ok=true) => el.innerHTML = `<div class="${ok?'ok':'err'}">${text}</div>`;
  let token = localStorage.getItem('seller_token') || '';
  let sellerId = localStorage.getItem('seller_id') || '';
  let userCache = null;

  // caches
  let mineCache = [];     // /api/seller/auctions
  let receiptCache = [];  // /api/receipts/mine/:sellerId

  // currency (TR)
  const fmtTRY = new Intl.NumberFormat('tr-TR', { style:'currency', currency:'TRY', maximumFractionDigits:0 });
  const IST_TZ = 'Europe/Istanbul';
  const fmtIST = d => new Date(d).toLocaleString('tr-TR', { timeZone: IST_TZ });

  // İstanbul gün anahtarı
  const istDayKey = d => new Intl.DateTimeFormat('tr-TR', { timeZone: IST_TZ, year:'numeric', month:'2-digit', day:'2-digit' }).format(new Date(d));
  const nowIstKey = () => istDayKey(Date.now());

  // Son 7 gün mü?
  function isWithinLastDays(date, days=7){
    const now = Date.now();
    const t = new Date(date).getTime();
    return t <= now && (now - t) <= days * 86400000;
  }

  // Adres haritaları
  const maps = { sehir: new Map(), ilce: new Map(), mahalle: new Map() };

  // Helpers for address JSON
  function pick(obj, keys){
    for (const k of keys){
      if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== '')
        return obj[k];
    }
    return undefined;
  }
  function collectIdNamePairs(json, idKeys, nameKeys, out){
    if (Array.isArray(json)){
      for (const it of json) collectIdNamePairs(it, idKeys, nameKeys, out);
      return;
    }
    if (json && typeof json === 'object'){
      const idRaw   = pick(json, idKeys);
      const nameRaw = pick(json, nameKeys);
      if (idRaw !== undefined && nameRaw){
        const id = Number(idRaw);
        const name = String(nameRaw);
        if (!Number.isNaN(id)) out.push([id, name]);
      }
      for (const v of Object.values(json)) collectIdNamePairs(v, idKeys, nameKeys, out);
    }
  }
  function addFromJsonToMap(json, map, idKeys, nameKeys){
    const pairs = [];
    collectIdNamePairs(json, idKeys, nameKeys, pairs);
    for (const [id, name] of pairs) if (!map.has(id)) map.set(id, name);
  }

  // ---- JSON cache (localStorage, 30 gün)
  async function cachedFetchJSON(key, url, ttlMs = 1000 * 60 * 60 * 24 * 30){
    const raw = localStorage.getItem(key);
    if (raw){
      try{
        const obj = JSON.parse(raw);
        if (Date.now() - obj.t < ttlMs) return obj.d;
      }catch{}
    }
    const d = await (await fetch(url)).json();
    localStorage.setItem(key, JSON.stringify({ t: Date.now(), d }));
    return d;
  }

  async function loadAddressMaps(){
    try{
      const s = await cachedFetchJSON('addr_sehir', ADDR_JSON.sehir);
      addFromJsonToMap(s, maps.sehir,
        ['id','SehirID','sehir_id','ilId','il_id','SehirNo'],
        ['name','SehirAdi','sehir_adi','title','ilAdi','il_adi']);
    }catch(e){ console.warn('Şehirler yüklenemedi:', e); }

    try{
      const ic = await cachedFetchJSON('addr_ilce', ADDR_JSON.ilce);
      addFromJsonToMap(ic, maps.ilce,
        ['id','IlceID','ilce_id','ilceId'],
        ['name','IlceAdi','ilce_adi','ilce_title','title']);
    }catch(e){ console.warn('İlçeler yüklenemedi:', e); }

    for (const [idx, url] of [ADDR_JSON.mahalle_1, ADDR_JSON.mahalle_2, ADDR_JSON.mahalle_3, ADDR_JSON.mahalle_4].entries()){
      try{
        const m = await cachedFetchJSON('addr_mah_'+(idx+1), url);
        addFromJsonToMap(m, maps.mahalle,
          ['id','MahalleID','mahalle_id','mahalleId'],
          ['name','MahalleAdi','mahalle_adi','mahalle_title','title']);
      }catch(e){ console.warn('Mahalle dosyası yüklenemedi:', url, e); }
    }
    console.log('Adres haritaları -> Şehir:', maps.sehir.size, 'İlçe:', maps.ilce.size, 'Mahalle:', maps.mahalle.size);
  }

  const nameOf = (map, id) => (id==null ? '' : (map.get(Number(id)) || String(id)));

  function setTab(name){
    document.querySelectorAll('nav .tab').forEach(b => b.classList.toggle('active', b.dataset.tab===name));
    ['add','mine','receipts'].forEach(t => $('tab-'+t).style.display = (t===name?'block':'none'));
    if (name === 'mine') startCountdownTick(); // görünürken sayaçlar aktif
  }
  document.querySelectorAll('nav .tab').forEach(b => b.addEventListener('click', () => setTab(b.dataset.tab)));

  // Görsel önizleme + modal
  const prev = $('prev'); const imgModal = $('imgModal'); const modalImg = $('modalImg'); const modalClose = $('modalClose');
  $('images')?.addEventListener('change', (e) => {
    if(!prev) return;
    prev.innerHTML = '';
    [...e.target.files].slice(0,5).forEach(f => {
      const u = URL.createObjectURL(f);
      const i = new Image(); i.src=u; i.width=96; i.height=96; i.className='preview-img';
      i.onclick = () => openModal(u);
      prev.appendChild(i);
    });
  });
  function openModal(src){ modalImg.src = src; imgModal.classList.add('open'); imgModal.setAttribute('aria-hidden','false'); }
  function closeModal(){ imgModal.classList.remove('open'); imgModal.setAttribute('aria-hidden','true'); }
  modalClose.onclick = closeModal;
  imgModal.addEventListener('click', (e) => { if(e.target===imgModal) closeModal(); });

  // ÇIKIŞ
  function setupLogout(){
    const btn = $('logoutBtn');
    if (!btn) return;
    btn.onclick = () => {
      localStorage.removeItem('seller_token');
      localStorage.removeItem('seller_id');
      localStorage.removeItem('user');
      location.reload();
    };
  }

  // LOGIN
  $('loginBtn').addEventListener('click', async () => {
    try {
      const r = await fetch(api.login, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email: $('email').value.trim(), password: $('password').value })
      });
      const j = await r.json();
      const tok = j.token || j.accessToken || j.jwt; // esnek
      if (!r.ok || !tok) return msg($('msg'), j.message||'Giriş başarısız', false);
      if ((j.user && j.user.role) !== 'seller') return msg($('msg'),'Bu panele sadece satıcı girebilir.', false);

      token = tok; sellerId = j.user._id; userCache = j.user;
      localStorage.setItem('seller_token', token);
      localStorage.setItem('seller_id', sellerId);
      localStorage.setItem('user', JSON.stringify(j.user));

      $('loginView').style.display='none';
      $('appView').style.display='block';
      setupLogout();
      await loadProfile();
      await loadAddressMaps();
      await loadMine();
      await loadReceipts();
      refreshOverview();
    } catch {
      msg($('msg'),'Ağ hatası', false);
    }
  });

  // Profil
  async function loadProfile(){
    try{
      const r = await fetch(api.profile, { headers:{ Authorization:'Bearer '+token }});
      const j = await r.json();
      const u = j?.user || userCache || JSON.parse(localStorage.getItem('user')||'{}');
      $('profileBox').innerHTML = `<b>Hoş geldiniz:</b> ${u.companyName||u.name||u.email} &nbsp; • &nbsp; <b>E-posta:</b> ${u.email}`;
    }catch{ /* sessiz geç */ }
  }

  // Mezat Ekle
  $('createBtn').addEventListener('click', async () => {
    const out = $('out-add');
    try {
      const fd = new FormData();
      fd.append('title', $('title').value);
      fd.append('description', $('description').value);
      fd.append('startingPrice', $('startingPrice').value);
      fd.append('isSigned', $('isSigned').value);
      [...$('images').files].slice(0,5).forEach(f => fd.append('images', f));

      const r = await fetch(api.createAuction, { method:'POST', headers:{ Authorization:'Bearer '+token }, body: fd });
      const j = await r.json();
      if (!j.ok) return msg(out, j.message||'Kayıt hatası', false);

      msg(out, 'Mezat oluşturuldu. ID: '+j.auctionId);
      ['title','description','startingPrice'].forEach(id => $(id).value='');
      if ($('images')) $('images').value='';
      if (prev) prev.innerHTML='';
      await loadMine();
      refreshOverview();
    } catch { msg(out,'Ağ hatası', false); }
  });

  // Mezatlarım (+ geri sayım)
  let timerInterval = null;
  function startCountdownTick(){
    if (timerInterval) clearInterval(timerInterval);
    const update = () => {
      const now = Date.now();
      document.querySelectorAll('[data-end]').forEach(el=>{
        const end = Number(el.getAttribute('data-end'));
        let diff = end - now;
        if (diff < 0) diff = 0;
        const hh = String(Math.floor(diff/3600000)).padStart(2,'0');
        const mm = String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
        const ss = String(Math.floor((diff%60000)/1000)).padStart(2,'0');
        el.textContent = `${hh}:${mm}:${ss}`;
      });
    };
    update();
    timerInterval = setInterval(update, 1000);
  }

  async function loadMine(){
    const box = $('mineList'); if (!box) return; box.innerHTML = '';
    try{
      const r = await fetch(api.myAuctions, { headers:{ Authorization:'Bearer '+token }});
      const j = await r.json();
      if (!j.ok) { box.innerHTML = '<div class="err">Liste alınamadı</div>'; return; }
      mineCache = Array.isArray(j.items) ? j.items : [];

      mineCache.forEach(a => {
        const d = document.createElement('div'); d.className='item';
        const img = document.createElement('img'); img.src = (a.images && a.images[0]) || ''; img.className='thumb';
        const info = document.createElement('div');

        const ended = !!a.isEnded;
        const status = ended ? `Bitti (${a.receiptStatus||'-'})` : 'Devam ediyor';
        const istEnd = fmtIST(a.endsAt);

        // sayaç elemanı (aktif mezatlar için)
        const timerSpan = !ended ? `<span class="timer" data-end="${new Date(a.endsAt).getTime()}">--:--:--</span>` : '';

        info.innerHTML = `
          <b>${a.title}</b><br/>
          ₺${a.currentPrice} • Bitiş (İstanbul): ${istEnd} • ${status}
          ${!ended ? `<br/>Kalan süre: ${timerSpan}`:''}
        `;
        d.appendChild(img); d.appendChild(info);
        box.appendChild(d);
      });

      startCountdownTick();
    }catch{ box.innerHTML = '<div class="err">Liste alınamadı</div>'; }
  }

  // Dekontlar – sellerId ile çağır + adres isimleri + onay/red loading
  async function loadReceipts(){
    const out = $('out-receipts'); const box = $('receiptList'); if (!box) return; box.innerHTML='';
    const sid = sellerId || (JSON.parse(localStorage.getItem('user')||'{}')._id);
    if (!sid){ msg(out,'Satıcı ID bulunamadı', false); return; }

    try{
      const r = await fetch(api.receiptsMine(sid), { headers:{ Authorization:'Bearer '+token }});
      if (!r.ok){ msg(out,'Dekont listesi alınamadı', false); return; }
      const items = await r.json(); // array
      receiptCache = Array.isArray(items) ? items : [];

      if (receiptCache.length===0){
        msg(out,'Gösterilecek dekont bulunamadı', false); 
        refreshOverview();
        return;
      }
      out.innerHTML = '';
      receiptCache.forEach(x => {
        const li = document.createElement('div'); li.className='item';

        const img = document.createElement('img'); img.src = x.receiptUrl || ''; img.className='thumb';
        img.style.cursor='zoom-in'; img.onclick = () => openModal(x.receiptUrl || '');

        const info = document.createElement('div');
        const buyer = x.buyer || {};
        const buyerName = buyer.name || buyer.email || '-';
        const status = (x.receiptStatus || 'pending').toLowerCase();
        const badgeClass = status==='approved' ? 'badge--approved' : status==='rejected' ? 'badge--rejected' : 'badge--pending';

        // Adres bloğu (sadece approved ise)
        let fullAddr = '';
        const addrDiv = document.createElement('div');
        if (status === 'approved' && buyer.address){
          const a = buyer.address;
          const ilName = nameOf(maps.sehir, a.ilId);
          const ilceName = nameOf(maps.ilce, a.ilceId);
          const mahalleName = nameOf(maps.mahalle, a.mahalleId);
          fullAddr =
            `${mahalleName ? (mahalleName+', ') : ''}${ilceName ? (ilceName+', ') : ''}${ilName || ''} • ` +
            [a.sokak, (a.apartmanNo ? 'No: '+a.apartmanNo : ''), (a.daireNo ? 'Daire: '+a.daireNo : '')]
              .filter(Boolean).join(' • ');
          addrDiv.className = 'addr';
          addrDiv.innerHTML = `<b>Alıcı Adresi</b><br/>${fullAddr}`;
          const copyBtn = document.createElement('button');
          copyBtn.className = 'btn btn-ghost';
          copyBtn.style.marginTop = '8px';
          copyBtn.textContent = 'Kopyala';
          copyBtn.onclick = async () => {
            try{
              await navigator.clipboard.writeText(fullAddr);
              const prev = copyBtn.textContent;
              copyBtn.textContent = 'Kopyalandı ✓';
              setTimeout(()=> copyBtn.textContent = prev, 1200);
            }catch{ alert('Kopyalama başarısız'); }
          };
          addrDiv.appendChild(document.createElement('br'));
          addrDiv.appendChild(copyBtn);
        }

        info.innerHTML = `
          <b>${x.title}</b><br/>
          Kazanan: ${buyerName}<br/>
          Bitiş (İstanbul): ${fmtIST(x.endsAt)}<br/>
          Durum: <span class="badge ${badgeClass}">${status}</span>
        `;
        if (addrDiv.innerHTML) info.appendChild(addrDiv);

        const actions = document.createElement('div'); actions.className='right';
        const isPending = status === 'pending';
        const ok = document.createElement('button'); ok.className='btn btn-primary'; ok.textContent='Onayla';
        const no = document.createElement('button'); no.className='btn btn-ghost';  no.textContent='Reddet';
        ok.disabled = !isPending; no.disabled = !isPending;

        ok.onclick = async () => {
          if (!isPending || ok.disabled) return;
          const prevTxt = ok.textContent;
          ok.disabled = no.disabled = true; ok.textContent = 'Onaylanıyor…';
          try{
            const rr = await fetch(api.approve(x._id), { method:'PATCH', headers:{ Authorization:'Bearer '+token }});
            if (rr.ok) { await loadReceipts(); refreshOverview(); } else { ok.disabled=no.disabled=false; ok.textContent=prevTxt; alert('Onay başarısız'); }
          }catch{ ok.disabled=no.disabled=false; ok.textContent=prevTxt; alert('Onay başarısız'); }
        };
        no.onclick = async () => {
          if (!isPending || no.disabled) return;
          const prevTxt = no.textContent;
          ok.disabled = no.disabled = true; no.textContent = 'Reddediliyor…';
          try{
            const rr = await fetch(api.reject(x._id),  { method:'PATCH', headers:{ Authorization:'Bearer '+token }});
            if (rr.ok) { await loadReceipts(); refreshOverview(); } else { ok.disabled=no.disabled=false; no.textContent=prevTxt; alert('Reddetme başarısız'); }
          }catch{ ok.disabled=no.disabled=false; no.textContent=prevTxt; alert('Reddetme başarısız'); }
        };

        li.appendChild(img); li.appendChild(info); li.appendChild(actions);
        actions.appendChild(ok); actions.appendChild(no);
        box.appendChild(li);
      });

      refreshOverview();
    }catch(e){
      console.error(e);
      msg(out,'Dekont listesi alınamadı', false);
    }
  }

  // OVERVIEW hesaplama (mobil değişmeden çalışır)
  function refreshOverview(){
    // Bugünkü & Haftalık satış: onaylanmış ve bitmiş mezatların currentPrice toplamı
    const todayKey = nowIstKey();

    const approvedEnded = mineCache.filter(a => a.isEnded && (a.receiptStatus||'').toLowerCase()==='approved');
    const todaySum = approvedEnded
      .filter(a => istDayKey(a.endsAt) === todayKey)
      .reduce((s,a)=> s + (Number(a.currentPrice)||0), 0);

    const weekSum = approvedEnded
      .filter(a => isWithinLastDays(a.endsAt, 7))
      .reduce((s,a)=> s + (Number(a.currentPrice)||0), 0);

    // Bekleyen dekont ve kargoya hazır: receipts listesinden
    const pendingCount  = receiptCache.filter(x => (x.receiptStatus||'').toLowerCase()==='pending').length;
    const approvedCount = receiptCache.filter(x => (x.receiptStatus||'').toLowerCase()==='approved').length;

    // Yakında bitecek (≤ 2 saat içinde bitecek aktif mezatlar)
    const now = Date.now();
    const endingSoonCount = mineCache.filter(a => !a.isEnded && (new Date(a.endsAt).getTime() - now) <= 2*60*60*1000 && (new Date(a.endsAt).getTime() - now) > 0).length;

    $('kpi-today').textContent   = fmtTRY.format(todaySum);
    $('kpi-week').textContent    = fmtTRY.format(weekSum);
    $('kpi-pending').textContent = String(pendingCount);
    $('kpi-approved').textContent= String(approvedCount);
    $('kpi-ending').textContent  = String(endingSoonCount);
  }

  // Sekme geçişinde veri yenile
  document.querySelector('[data-tab="mine"]').addEventListener('click', async ()=>{
    await loadMine();
    refreshOverview();
  });
  document.querySelector('[data-tab="receipts"]').addEventListener('click', async ()=>{
    await loadReceipts();
    refreshOverview();
  });

  // Oturum varsa otomatik devam
  (async function boot(){
    const has = token && sellerId;
    setupLogout();
    if (has){
      $('loginView').style.display='none';
      $('appView').style.display='block';
      try{ userCache = JSON.parse(localStorage.getItem('user')||'{}'); }catch{}
      await loadProfile();
      await loadAddressMaps();
      await loadMine();
      // receipts sekmesi seçilince yüklenir
      refreshOverview();
    }
  })();
</script>
</body>
</html>
